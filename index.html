<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Arbre G√©n√©alogique Firebase - Vertical</title>

<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    max-width: 900px;
    margin: 20px auto;
    background: #f8fafc;
    color: #222;
  }

  h1 {
    text-align: center;
    margin-bottom: 1rem;
  }

  form {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    margin-bottom: 20px;
  }

  input, select, button {
    padding: 8px 12px;
    font-size: 1rem;
    border-radius: 6px;
    border: 1.5px solid #007bff;
    outline-offset: 2px;
  }

  button {
    background-color: #007bff;
    color: white;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  button:hover {
    background-color: #0056b3;
  }

  #tree {
    display: flex;
    justify-content: center;
  }

  /* Arbre vertical en flex column */
  .tree-node {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    padding: 0 12px;
  }

  .node-box {
    background: white;
    border: 2px solid #007bff;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    user-select: none;
    min-width: 120px;
    text-align: center;
    transition: background-color 0.3s ease;
  }

  .node-box:hover {
    background-color: #cce4ff;
  }

  /* Traits verticaux */
  .tree-node::before {
    content: "";
    position: absolute;
    top: 0;
    left: 50%;
    border-left: 2px solid #007bff;
    height: 20px;
    transform: translateX(-50%);
  }

  /* Supprimer trait pour racine */
  .tree-root.tree-node::before {
    content: none;
  }

  /* Conteneur enfants */
  .children {
    display: flex;
    justify-content: center;
    margin-top: 20px;
    gap: 20px;
    position: relative;
  }

  /* Traits horizontaux entre enfants */
  .children::before {
    content: "";
    position: absolute;
    top: 0;
    left: 10%;
    right: 10%;
    border-top: 2px solid #007bff;
  }

  /* Trait vertical de chaque enfant au trait horizontal */
  .children > .tree-node::before {
    top: -20px;
  }

  /* Modal √©dition */
  #edit-section {
    margin-top: 30px;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
    max-width: 320px;
    margin-left: auto;
    margin-right: auto;
    display: none;
  }

  #edit-section input {
    width: 100%;
    padding: 8px 12px;
    font-size: 1.1rem;
    margin-bottom: 15px;
    border-radius: 8px;
    border: 1.5px solid #007bff;
    outline-offset: 2px;
  }

  #edit-section button {
    padding: 10px 18px;
    font-weight: 600;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    margin-right: 10px;
  }

  #save-edit {
    background-color: #007bff;
    color: white;
  }
  #save-edit:hover {
    background-color: #0056b3;
  }

  #delete-edit {
    background-color: #e03e2f;
    color: white;
  }
  #delete-edit:hover {
    background-color: #b22a20;
  }

  #cancel-edit {
    background-color: #999;
    color: white;
  }
  #cancel-edit:hover {
    background-color: #666;
  }

  @media (max-width: 600px) {
    form {
      flex-direction: column;
    }
    input, select, button {
      width: 100%;
    }
    .children {
      flex-direction: column;
      gap: 15px;
    }
    .children::before {
      left: 50%;
      right: auto;
      height: 20px;
      border-top: none;
      border-left: 2px solid #007bff;
      top: 10px;
    }
    .children > .tree-node::before {
      top: 10px;
      left: 50%;
      height: 20px;
      border-left: none;
      border-top: 2px solid #007bff;
      transform: translateX(-50%);
    }
  }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

</head>
<body>

<h1>Arbre G√©n√©alogique Firebase - Vertical</h1>

<form id="add-form">
  <input type="text" id="name" placeholder="Nom de la personne" required autocomplete="off" />
  <select id="parent">
    <option value="">Aucun parent (racine)</option>
  </select>
  <button type="submit">Ajouter</button>
</form>

<div id="tree"></div>

<div id="edit-section">
  <h3>Modifier membre</h3>
  <input type="text" id="edit-name" />
  <button id="save-edit">üíæ Sauvegarder</button>
  <button id="delete-edit">‚ùå Supprimer</button>
  <button id="cancel-edit">Annuler</button>
</div>

<script>
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCuXPX7SA8m8wr0KO4my2U5SRO4pT0FEj8",
    authDomain: "arbrefamillenomogo.firebaseapp.com",
    projectId: "arbrefamillenomogo",
    storageBucket: "arbrefamillenomogo.appspot.com",
    messagingSenderId: "1018139402299",
    appId: "1:1018139402299:web:14e689837f58bfabb9fc1e"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const membersCol = db.collection("members");

  let members = [];
  let editingId = null;

  // Charger membres en temps r√©el
  function loadMembersRealtime() {
    membersCol.onSnapshot(snapshot => {
      members = [];
      snapshot.forEach(doc => {
        members.push({ id: doc.id, ...doc.data() });
      });
      renderParentOptions();
      renderTree();
      hideEditSection();
    }, err => {
      console.error("Erreur Firestore :", err);
      document.getElementById("tree").textContent = "Erreur de chargement.";
    });
  }

  // Rendu r√©cursif de l'arbre en DOM
  function createNodeElement(member) {
    const div = document.createElement("div");
    div.className = "tree-node";
    if (!member.parentId) div.classList.add("tree-root");

    const box = document.createElement("div");
    box.className = "node-box";
    box.textContent = member.name;
    box.onclick = () => openEdit(member.id);
    div.appendChild(box);

    // Enfants
    const children = members.filter(m => m.parentId === member.id);
    if (children.length > 0) {
      const childrenContainer = document.createElement("div");
      childrenContainer.className = "children";
      children.forEach(child => {
        childrenContainer.appendChild(createNodeElement(child));
      });
      div.appendChild(childrenContainer);
    }

    return div;
  }

  function renderTree() {
    const treeDiv = document.getElementById("tree");
    treeDiv.innerHTML = "";
    const roots = members.filter(m => !m.parentId);
    if (roots.length === 0) {
      treeDiv.textContent = "Aucun membre. Ajoutez le premier membre.";
      return;
    }
    roots.forEach(root => {
      treeDiv.appendChild(createNodeElement(root));
    });
  }

  // Remplir le select parent
  function renderParentOptions() {
    const sel = document.getElementById("parent");
    sel.innerHTML = '<option value="">Aucun parent (racine)</option>';
    members.forEach(m => {
      sel.innerHTML += `<option value="${m.id}">${escapeHtml(m.name)}</option>`;
    });
  }

  // √âchapper texte
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, m => ({
      '&': "&amp;", '<': "&lt;", '>': "&gt;", '"': "&quot;", "'": "&#039;"
    })[m]);
  }

  // Ajout membre
  document.getElementById("add-form").addEventListener("submit", async e => {
    e.preventDefault();
    const nameInput = document.getElementById("name");
    const parentSelect = document.getElementById("parent");
    const name = nameInput.value.trim();
    const parentId = parentSelect.value || null;
    if (!name) {
      alert("Veuillez entrer un nom.");
      return;
    }
    try {
      await membersCol.add({ name, parentId });
      nameInput.value = "";
      parentSelect.value = "";
    } catch (err) {
      alert("Erreur ajout : " + err.message);
    }
  });

  // Ouvrir √©dition
  function openEdit(id) {
    editingId = id;
    const member = members.find(m => m.id === id);
    if (!member) return;
    document.getElementById("edit-name").value = member.name;
    showEditSection();
  }

  // Modifier membre
  document.getElementById("save-edit").addEventListener("click", async () => {
    const newName = document.getElementById("edit-name").value.trim();
    if (!newName) {
      alert("Le nom ne peut pas √™tre vide.");
      return;
    }
    if (!editingId) return;
    try {
      await membersCol.doc(editingId).update({ name: newName });
      hideEditSection();
    } catch (err) {
      alert("Erreur modification : " + err.message);
    }
  });

  // Supprimer membre
  document.getElementById("delete-edit").addEventListener("click", async () => {
    if (!editingId) return;
    if (!confirm("Supprimer ce membre ? Ses enfants deviendront orphelins.")) return;
    try {
      await membersCol.doc(editingId).delete();
      // Orphelins
      const batch = db.batch();
      members.filter(m => m.parentId === editingId).forEach(child => {
        batch.update(membersCol.doc(child.id), { parentId: null });
      });
      await batch.commit();
      hideEditSection();
    } catch (err) {
      alert("Erreur suppression : " + err.message);
    }
  });

  // Annuler √©dition
  document.getElementById("cancel-edit").addEventListener("click", () => {
    hideEditSection();
  });

  function showEditSection() {
    document.getElementById("edit-section").style.display = "block";
  }
  function hideEditSection() {
    editingId = null;
    document.getElementById("edit-section").style.display = "none";
  }

  // Init
  loadMembersRealtime();
</script>

</body>
</html>

